<polymer-element name="g-excel" attributes="file">
	<template>
		<link rel="stylesheet" href="g-excel.css">
		<g-table id="table"></g-table>
	</template>
	<script>
    	Polymer('g-excel', {
			parser: null,
            data: null,
			
            getData: function() {
                return this.data;
            },

    		getParser: function() {
    			if(this.parser == null)
    			{
					this.parser = require('gl!guara/excel');
    			}
    			return this.parser;
    		},
    		
    		parseSheet: function(sheet, handler) {
   				
    			if(!sheet)
   				{
   					throw "No sheet";
   				}

				var parser = this.getParser();
   				var array  = parser.toArray(sheet);

   				handler.handleHeader(sheet, array[0]);
 				for(var i = 1; i < array.length; i++)
 				{
 					var row = array[i];
 					handler.handleRow(sheet, row, i);
 				}
    		
                this.data = array;
            },
    		
    		clear: function() {
    			this.$.table.clear();
    		},
    		
    		fileChanged: function(oldVal, newVal) {
    			
    			this.clear();
    			var $this = this;

                this.$.table.title = this.file.name;
                
    			this.getParser().sheetByIndex(this.file, 0, function(sheet){
    				$this.parseSheet(sheet, {
    					
    					handleRow: function(sheet, row, i) {
    						$this.$.table.appendRow(row);
    					},
    					
    					handleHeader: function(sheet, header) {
    						var columns = [];
    						
    						$.each(header, function(key, value) {
    							columns.push(key);
    						});
    						
    						$this.$.table.columns = columns;
    					}
    				});
    			});
    		}
    	});
	</script>
</polymer-element>