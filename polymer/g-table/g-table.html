<polymer-element name="g-table" attributes="title columns rows actions">
	<template>
		<link rel="stylesheet" href="g-table.css">
		<div class="{{ class }}">
			<h3 id="title">{{ title }}</h3>
			<table id="table" class="table table-hover" on-click="{{ whenClicked }}" on-mouseover="{{ whenMouseOver }}" on-mouseout="{{ whenMouseOut }}">
				<thead>
					<tr>
						<template repeat="{{ column, j in columns }}">
							<template if="{{ column.length }}">
								<th style="width: {{ column.length }};">{{ column.title }}</th>
							</template>
							<template if="{{ !column.length }}">
								<th>{{ column.title }}</th>
							</template>
							
						</template>
					</tr>
				</thead>
				<tfoot></tfoot>
				<tbody>
					<template repeat="{{ row, i in rows }}">
						<tr class="{{ row.error ? 'danger' : 'noerror'}}">
							<template repeat="{{ column, j in columns }}">
								<template if="{{ column.name == '_actions' }}">
									<td>
										<template if="{{ row._actions.type == 'dropdown' }}">
											<g-dropdown label="Ações" options="{{ row._actions.options }}" type="primary"></g-dropdown>
										</template>
										<template if="{{ row._actions.type == 'button' }}">
											<template repeat="{{ option in  row._actions.options }}">
												<g-button label="{{ option.label }}" type="{{ option.type }}" href="{{ option.href }}"></g-button>
											</template>
										</template>
									</td>
								</template>

								<template if="{{ column.name != '_actions' }}">
									<td on-click="{{ }}" class="{{ row.data[column.name].error ? 'error' : '' }}">
										<g-cell text="{{ row.data[column.name].value }}"
												error="{{ row.data[column.name].error }}"
												errorMessage="{{ row.data[column.name].errorMessage }}"></g-cell>
									</td>
								</template>
							</template>
						</tr>
					</template>			
				</tbody>
			</table>
		</div>
	</template>
	<script>
    	Polymer('g-table', {

    		columns: [], /* The Header */

    		rows:[],

    		class: "hide",

    		clear: function() {
    			this.rows = [];
    			this.class = "hide";
    		},

    		appendRow: function(raw) {
				
    			var rowData = {};

    			$.each(raw, function(name, value){
    				rowData[name] = {
						value  : value,
						error  : false,
					};
				});
    			
    			this.rows.push({
					data  : rowData,
					error : false,
				});

    			this.class = "show rounded";
    		},
    		
    		mark: function(rowNumber, columnName, marker) {
    			//console.log("Marking", rowNumber, columnName);
    			var $this = this;
    			$.each(this.rows, function(i, row){
    				if(i == rowNumber)
    				{
    					row.error = true;
    					$.each(row.data, function(name, value) {
    						if(columnName == name)
    						{
    							//var cell = $this.$.table.getElementById(i + '_' + name);
   								marker(row.data[name]);
    						}
    					});
    				}
    			}); 
    		},
    		
    		getCell: function(evt) {
    			var nodeName = evt.target.nodeName;
    			if("G-CELL" == nodeName)
    			{
    				return evt.target;
    			}
    			if(false && "TD" == nodeName)
    			{
    				var cell = evt.target.querySelector('g-cell');
    				if(cell)
    				{
    					return cell;
    				}
    			}
				return null;
    		},
    		
    		whenMouseOver: function(evt, detail, sender) {
    			var cell = this.getCell(evt);
    			if(cell)
    			{
	    			cell.onMouseOver(evt, detail, sender);
    			}
    		},

    		whenMouseOut: function(evt, detail, sender) {
    			var cell = this.getCell(evt);
    			if(cell)
    			{
	    			cell.onMouseOut(evt, detail, sender);
    			}
    		},

    		whenClicked: function(evt, detail, sender) {
    			
    			var cell = this.getCell(evt);
    			if(cell)
    			{
					cell.onClick(evt, detail, sender);    			
    			}
    		}
    	});
	</script>
</polymer-element>