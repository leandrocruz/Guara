<polymer-element name="g-table" extends="g-base" attributes="schema validate title rows actions page pageSize lineCount enableRowSelection">
	<template>
		<link rel="stylesheet" href="g-table.css">
		<div id="loading" class="hidden">
			Carregando...
		</div>

		<div class="{{ class }}">
			<h3 id="title">{{ title }}</h3>
			<div id="paginator" class="btn-group">
				<button type="button" class="btn btn-default" id="toPrevious" href="#" on-click="{{ previousPage }}" >&lt;</button>
				<button type="button" class="btn btn-default">Resultados: {{ (page * pageSize) + 1 }} - {{ rows.length < (page + 1) * pageSize ? rows.length : (page + 1) * pageSize }} / total: {{ rows.length }} / página: {{ page + 1 }}</button>
				<button type="button" class="btn btn-default" id="toNext" on-click="{{ nextPage }}">&gt;</button>	
			</div>

			<table id="table" class="table table-hover" on-click="{{ whenClicked }}" on-mouseover="{{ whenMouseOver }}" on-mouseout="{{ whenMouseOut }}">
				<thead>
					<tr>

						<template if="{{ lineCount }}">
							<th>#</th>
						</template>
						
						<template if="{{ enableRowSelection }}">
							<th>
							<span class="glyphicon glyphicon-pushpin" style="font-size:80%;" on-click="{{  selectAll }}"></span>
							</th>
						</template>
						
						<template repeat="{{ column, j in columns }}">
							<template if="{{ column.name | include }}">
								<template if="{{ column.length }}">
									<th style="width: {{ column.length }};">{{ column.title }}</th>
								</template>
								<template if="{{ !column.length }}">
									<th>{{ column.title }}</th>
								</template>
							</template>
						</template>

					</tr>
				</thead>
				<tfoot></tfoot>
				<tbody>
					<template repeat="{{ row, i in buffer }}">

						<tr class="{{ (row.error ? 'danger' : 'noerror') }}" >

							<template if="{{ lineCount }}">
								<td>{{ row.index + 1}}</td>
							</template>
							
							<template if="{{ enableRowSelection }}">
								<td>
									<template if="{{ row.selected }}">
										<template if="{{ row.disabled }}">
											<span class="glyphicon glyphicon-{{ row.disabled }}"></span>
										</template>
										<template if="{{ !row.disabled }}">
											<input 	type="checkbox"
													on-click="{{ onItemSelected }}"
													data-idx="{{ row.index }}" 
													checked />
										</template>
									</template>
									<template if="{{ !row.selected }}">
										<template if="{{ row.disabled }}">
											<span class="glyphicon glyphicon-{{ row.disabled }}"></span>
										</template>
										<template if="{{ !row.disabled }}">
											<input 	type="checkbox"
													on-click="{{ onItemSelected }}"
													data-idx="{{ row.index }}" />
										</template>
									</template>
								</td>
							</template>

							<template repeat="{{ column, j in columns }}">
								<template if="{{ column.name | include }}">
									<template if="{{ column.name == '_actions' }}">
										<td>
											<template if="{{ column.type == 'dropdown' }}">
												<g-dropdown label="Ações" options="{{ column.options }}" type="primary"></g-dropdown>
											</template>
											<template if="{{ column.type == 'button' }}">
												<template repeat="{{ option in  column.options }}">
													<g-button label="{{ option.label }}" type="{{ option.type }}" href="{{ option.href }}"></g-button>
												</template>
											</template>
										</td>
									</template>
									<template if="{{ column.name != '_actions' }}" bind="{{ row.data[column.name] }}">
										<td class="{{ error ? 'error' : '' }}">
											<g-cell text="{{ value }}"
													error="{{ error }}"
													errorMessage="{{ errorMessage }}"></g-cell>
										</td>
									</template>
								</template>
							</template>
						</tr>
					</template>			
				</tbody>
			</table>
		</div>
	</template>
	<script>
    	Polymer('g-table', {

    		page               : 0,      /* Pagination */
    		pageSize           : 25,
    		enableRowSelection : false,
    		lineCount          : false,
    		validate           : true,
    		class              : "hide",

    		created: function() {
    			this.buffer  = [];
    			this.rows    = [];
    			this.columns = [];
    			this.schema  = {};
    		},

    		include: function(value) { /* filter */
    			return !value.startsWith('__');
    		},
    		
    		clear: function() {
    			this.page   = 0;
    			this.rows   = [];
    			this.buffer = [];
    			this.class  = "hide";
    		},
    		
    		show: function() {
    			this.buffer = [];
    			var last  = this.rows.length - 1
    			var start = this.page * this.pageSize;
    			var end   = ((this.page + 1) * this.pageSize) - 1;
    			end = last < end ? last : end;
    			for(var i = start; i <= end ; i++)
    			{
    				var entry = this.rows[i];
    				this.buffer.push(entry);
    			}
    			
    			this.$.toNext.className     = this.isPageValid(this.page + 1) ? "btn btn-default" : "hide";
    			this.$.toPrevious.className = this.isPageValid(this.page - 1) ? "btn btn-default" : "hide";

    			this.class = "show rounded";
    		},

    		isPageValid: function(n) {
				if(n < 0)
				{
					return false;
				}
    			var len = this.rows.length;
				return len > (n * this.pageSize);
    		},

    		previousPage: function(evt, detail, sender) {
    			evt.preventDefault();
    			if(this.page > 0)
    			{
    				this.page--;
    				this.show();
    			}
    		},
    		
    		nextPage: function(evt, detail, sender) {
    			evt.preventDefault();
    			this.page++;
    			this.show();
    		},

    		toRowData: function(raw) {

    			var $this    = this;
    			var rowData  = {rowError: false};
    			
    			$.each(this.schema, function(name, validators) {
    				
    				var value = raw[name];
    				var error = false;
    				var msg   = '';

    				if($this.validate && validators)
    				{
    					//console.log('Validating', name, value);
    					var result = $g.validator.validateValue(value, validators);
    					error = !result.isValid;
    					if(error)
    					{
    						rowData.rowError = true;
	    					msg = result.issues[0].message;
    					}
    				}
    				
    				rowData[name] = {
   						value        : value,
   						error        : error,
   						errorMessage : msg
   					};
    			});
    			
    			return rowData;
    		},
    		
    		appendRow: function(raw) {

    			var index   = this.rows.length;
    			var rowData = this.toRowData(raw);

    			var entry = {
					index : index,
					data  : rowData,
    				error : rowData.rowError
    			};

    			//console.log(entry);
    			this.rows.push(entry);
    		},
    		
    		unmark: function(rowNumber) {
    			var data = this.rows[rowNumber].data;
    			$.each(data, function(name, cell) {
    				cell.error = false;
    				cell.errorMessage = null;
    			});
    		},

    		mark: function(rowNumber, columnName, issues) {
   				var cell = this.rows[rowNumber].data[columnName];
   				cell.error = true;
   				if(issues)
   				{
	   				if(typeof issues === 'string')
	   				{
	   					cell.errorMessage = issues; 
	   				}
	   				else
	   				{
		    			$.each(this.issues, function(idx, issue){
		    				cell.errorMessage = issue.message;
		    			});
	   				}
   				}
    		},
    		
    		/*
    		getCell: function(evt) {
    			var nodeName = evt.target.nodeName;
    			if("G-CELL" == nodeName)
    			{
    				return evt.target;
    			}
    			if(false && "TD" == nodeName)
    			{
    				var cell = evt.target.querySelector('g-cell');
    				if(cell)
    				{
    					return cell;
    				}
    			}
				return null;
    		},

    		whenMouseOver: function(evt, detail, sender) {
    			var cell = this.getCell(evt);
    			if(cell)
    			{
	    			cell.onMouseOver(evt, detail, sender);
    			}
    		},

    		whenMouseOut: function(evt, detail, sender) {
    			var cell = this.getCell(evt);
    			if(cell)
    			{
	    			cell.onMouseOut(evt, detail, sender);
    			}
    		},

    		whenClicked: function(evt, detail, sender) {
    			
    			var cell = this.getCell(evt);
    			if(cell)
    			{
					cell.onClick(evt, detail, sender);    			
    			}
    		},
    		*/

    		selectAllRows: function(select) {
    			for (var i = 0; i < this.rows.length; i++)
    			{
    				var row = this.rows[i];
    				row.selected = select;
    			}
    		},
    		
    		selectAll: function(evt, detail, sender) {
    			//console.log(evt.shiftKey);
    			//console.log(evt.ctrlKey);
    			this.selectAllRows(true);
    		},
    		
    		onItemSelected: function(evt, detail, sender) {
    			var idx = sender.getAttribute('data-idx');
    			var row = this.rowByIndex(idx);
    			if(row)
    			{
    				row.selected = !row.selected;
    			}
    		},
    		
    		rowByIndex: function(index) {
    			for (var i = 0; i < this.rows.length; i++)
    			{
    				var row = this.rows[i];
    				if(row.index == index)
    				{
    					return row;
    				}
    			}
    		},
    		
    		getSelected: function() {
    			
    			var result = [];
    			
    			$.each(this.rows, function(i, row){
    				if(row.selected)
    				{
    					result.push(row);
    				}
    			});
	
				return result;
    		},
    		
    		schemaChanged: function() {
    			var columns = [];
    			$.each(this.schema, function(key, value){
    				columns.push({name: key, title: key});
    			});
    			this.columns = columns;
    		},
    	});
	</script>
</polymer-element>