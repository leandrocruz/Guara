<polymer-element name="g-table" attributes="title columns rows actions page pageSize">
	<template>
		<link rel="stylesheet" href="g-table.css">
		<div id="loading" class="hidden">
			Carregando...
		</div>
		<div class="{{ class }}">
			<h3 id="title">{{ title }}</h3>
			<div id="paginator" class="btn-group">
				<button type="button" class="btn btn-default" id="toPrevious" href="#" on-click="{{ previousPage }}" >&lt;</button>
				<button type="button" class="btn btn-default">Resultados: {{ (page * pageSize) + 1 }} - {{ rows.length < (page + 1) * pageSize ? rows.length : (page + 1) * pageSize }} / total: {{ rows.length }} / página: {{ page + 1 }}</button>
				<button type="button" class="btn btn-default" id="toNext" on-click="{{ nextPage }}">&gt;</button>	
			</div>			
			<table id="table" class="table table-hover" on-click="{{ whenClicked }}" on-mouseover="{{ whenMouseOver }}" on-mouseout="{{ whenMouseOut }}">
				<thead>
					<tr>
						<template repeat="{{ column, j in columns }}">
							<template if="{{ column.length }}">
								<th style="width: {{ column.length }};">{{ column.title }}</th>
							</template>
							<template if="{{ !column.length }}">
								<th>{{ column.title }}</th>
							</template>
						</template>
					</tr>
				</thead>
				<tfoot></tfoot>
				<tbody>
					<template repeat="{{ row, i in buffer }}">
						<tr class="{{ row.error ? 'danger' : 'noerror'}}" data-idx="{{ i }}">
							<template repeat="{{ column, j in columns }}">
								<template if="{{ column.name == '_actions' }}">
									<td>
										<template if="{{ column.type == 'dropdown' }}">
											<g-dropdown label="Ações" options="{{ column.options }}" type="primary"></g-dropdown>
										</template>
										<template if="{{ column.type == 'button' }}">
											<template repeat="{{ option in  column.options }}">
												<g-button label="{{ option.label }}" type="{{ option.type }}" href="{{ option.href }}"></g-button>
											</template>
										</template>
										<template if="{{ column.type == 'checkbox' }}">
											<input name="{{ column.input_name }}" type="checkbox" value="{{ row.data[column.name].value }}" on-click="{{ onItemSelected }}" data-idx="{{ i }}"/>
										</template>
									</td>
								</template>

								<template if="{{ column.name != '_actions' }}">
									<td class="{{ row.data[column.name].error ? 'error' : '' }}">
										<g-cell text="{{ row.data[column.name].value }}"
												error="{{ row.data[column.name].error }}"
												errorMessage="{{ row.data[column.name].errorMessage }}"></g-cell>
									</td>
								</template>
							</template>
						</tr>
					</template>			
				</tbody>
			</table>
		</div>
	</template>
	<script>
    	Polymer('g-table', {

    		page     : 0,      /* Pagination */
    		pageSize : 25,
    		buffer   : [],

    		columns  : [],     /* The Header */
    		rows     : [],
    		class    : "hide",

    		clear: function() {
    			this.page   = 0;
    			this.rows   = [];
    			this.buffer = [];
    			this.class  = "hide";
    		},
    		
    		show: function() {
    			this.buffer = [];
    			var last  = this.rows.length;
    			var start = this.page * this.pageSize;
    			var end   = ((this.page + 1) * this.pageSize) - 1;
    			end = last < end ? last : end;
    			for(var i = start; i <= end ; i++)
    			{
    				var entry = this.rows[i];
    				this.buffer.push(entry);
    			}
    			
    			this.$.toNext.className     = this.isPageValid(this.page + 1) ? "btn btn-default" : "hide";
    			this.$.toPrevious.className = this.isPageValid(this.page - 1) ? "btn btn-default" : "hide";

    			this.class = "show rounded";
    		},

    		isPageValid: function(n) {
				if(n < 0)
				{
					return false;
				}
    			var len = this.rows.length;
				return len > (n * this.pageSize);
    		},

    		previousPage: function(evt, detail, sender) {
    			evt.preventDefault();
    			if(this.page > 0)
    			{
    				this.page--;
    				this.show();
    			}
    		},
    		
    		nextPage: function(evt, detail, sender) {
    			evt.preventDefault();
    			this.page++;
    			this.show();
    		},

    		appendRow: function(raw) {

    			var rowData = {};

    			$.each(raw, function(name, value){
    				rowData[name] = {
						value  : value,
						error  : false,
					};
				});

    			var entry = {
    				data  : rowData,
    				error : false,
    			};

    			this.rows.push(entry);
    		},
    		
    		mark: function(rowNumber, columnName, marker) {
    			//console.log("Marking", rowNumber, columnName);
    			var $this = this;
    			$.each(this.rows, function(i, row){
    				if(i == rowNumber)
    				{
    					row.error = true;
    					$.each(row.data, function(name, value) {
    						if(columnName == name)
    						{
    							//var cell = $this.$.table.getElementById(i + '_' + name);
   								marker(row.data[name], row);
    						}
    					});
    				}
    			}); 
    		},
    		
    		getCell: function(evt) {
    			var nodeName = evt.target.nodeName;
    			if("G-CELL" == nodeName)
    			{
    				return evt.target;
    			}
    			if(false && "TD" == nodeName)
    			{
    				var cell = evt.target.querySelector('g-cell');
    				if(cell)
    				{
    					return cell;
    				}
    			}
				return null;
    		},
    		
    		whenMouseOver: function(evt, detail, sender) {
    			var cell = this.getCell(evt);
    			if(cell)
    			{
	    			cell.onMouseOver(evt, detail, sender);
    			}
    		},

    		whenMouseOut: function(evt, detail, sender) {
    			var cell = this.getCell(evt);
    			if(cell)
    			{
	    			cell.onMouseOut(evt, detail, sender);
    			}
    		},

    		whenClicked: function(evt, detail, sender) {
    			
    			var cell = this.getCell(evt);
    			if(cell)
    			{
					cell.onClick(evt, detail, sender);    			
    			}
    		},
    		
    		onItemSelected: function(evt, detail, sender) {
    			var wanted = sender.getAttribute('data-idx');
    			var rows = this.shadowRoot.querySelectorAll('tr');
    			$.each(rows, function(idx, row){
    				var dataIdx = row.getAttribute('data-idx')
    				if(dataIdx == wanted)
    				{
    					$(row).toggleClass("selected");
    				}
    			});
    		},
    		
    		getSelected: function() {
    			
    			var result = [];
    			var items = this.shadowRoot.querySelectorAll('input[type="checkbox"]');
				$.each(items, function(idx, item){
					if(item.checked)
					{
						result.push(item);
					}
				});

				return result;
    		}
    	});
	</script>
</polymer-element>